{% extends 'base.html' %}
{% load static %}

{% block title %}<title>商城中心</title>{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    @media screen and (max-width: 320px) {
        .g-header-container.fixed {
            padding: 5px;
        }

        .g-footer-container {
            padding: 5px;
        }

        .m-button {
            margin-right: 5px;
            font-size: 12px;
        }
    }

    .title {
        text-align: center;
    }

    .container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 20px auto;
        width: 90%;
        max-width: 500px;
    }

    .cart-container {
        position: fixed;
        top: 90px;
        right: 20px;
        z-index: 1000;
    }

    .cart-icon {
        font-size: 24px;
    }

    .item-count {
        position: absolute;
        top: -5px;
        right: -10px;
        background-color: red;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }

    .product {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin: 10px;
        width: 200px;
        padding: 10px;
    }

    .product img {
        max-width: 100%;
        border-radius: 8px;
    }

    .product h3 {
        font-size: 16px;
        color: #333;
        margin: 10px 0;
    }

    .product p {
        font-size: 14px;
        color: #777;
        margin: 5px 0;
    }

    .product .price {
        font-size: 18px;
        color: #000;
        margin: 5px 0;
    }

    .add-to-cart {
        display: inline-block;
        padding: 10px 20px;
        margin-top: 10px;
        color: white;
        background-color: #000;
        border: none;
        border-radius: 4px;
        text-decoration: none;
        font-size: 14px;
    }

    .add-to-cart:hover {
        cursor: pointer;
    }

    .login-to-cart:hover {
        cursor: pointer;
    }

    .i-button {
        font-family: "Zen Kurenaido", sans-serif;
        border-radius: 16px;
        color: #000;
        background-color: #FFF279;
    }

    .i-button:hover {
        font-family: "Zen Kurenaido", sans-serif;
        border-radius: 16px;
        color: #fff;
        background-color: #777777;
    }

    .button-container {
        text-align: center;
    }
</style>

<div class="mall">
    <div class="title">
        <h1>商城</h1>
    </div>

    <div class="cart-container">
        <a href="javascript:void(0);" id="cart-link">
            <i class="fas fa-shopping-cart cart-icon"></i>
            <span id="item-count" class="item-count">0</span>
        </a>
    </div>

    <div class="container">
        {% if products.exists %}
            {% for product in products %}
            <div class="product" data-id="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}">
                <a href="{% url 'product_detail' product.id %}">
                    <img src="{{ product.image.url }}" alt="{{ product.name }}">
                </a>
                <h3>{{ product.name }}</h3>
                <p class="price">${{ product.price }}</p>
                {% if user.is_authenticated %}
                <a class="add-to-cart">加入購物車</a>
                {% else %}
                <a href="{% url 'login' %}" class="login-to-cart">加入購物車</a>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p>当前没有商品。</p>
        {% endif %}
    </div>

    <div class="button-container">
        <a href="{% url 'home' %}"><button class="i-button">回首頁</button></a>
    </div>
</div>

<script>
const addToCartButtons = document.querySelectorAll('.add-to-cart');
const loginToCartLinks = document.querySelectorAll('.login-to-cart');
const itemCountElement = document.getElementById('item-count');  // 获取购物车数量的 DOM 元素

// 更新购物车计数器
function updateCartCounter() {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);  // 计算购物车中的总数量
    itemCountElement.textContent = totalQuantity;  // 更新计数器显示
}

// 为所有 "加入购物车" 按钮添加点击事件
addToCartButtons.forEach(button => {
    button.addEventListener('click', () => {
        const product = button.parentElement;
        const id = product.getAttribute('data-id');
        const name = product.getAttribute('data-name');
        const price = parseInt(product.getAttribute('data-price'), 10);
        const quantity = 1; // 默認設置 quantity 為 1

        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        // 查找是否已存在該商品，若存在則增加数量
        const existingProduct = cart.find(item => item.id === id);
        if (existingProduct) {
            existingProduct.quantity += 1;  // 若商品已在购物车中，增加数量
        } else {
            cart.push({ id, name, price, quantity });  // 新商品则添加到购物车
        }

        localStorage.setItem('cart', JSON.stringify(cart));

        // 更新购物车计数器
        updateCartCounter();

        // 提示用户商品已加入购物车
        alert(`${name} 已加入購物車!`);
    });
});

// 初始化时更新购物车计数器
updateCartCounter();

loginToCartLinks.forEach(link => {
    link.addEventListener('click', () => {
        alert("請先登入才能加入購物車!");
        window.location.href = "{% url 'login' %}";
    });
});

// 监听购物车图标点击，跳转至购物车页面
document.getElementById('cart-link').addEventListener('click', function () {
    // 判断用户是否已登录
    {% if user.is_authenticated %}
        // 如果用户已登录，跳转到购物车页面
        window.location.href = "{% url 'shopingcar' %}";
    {% else %}
        // 如果用户未登录，提示需要登录并跳转到登录页面
        alert("請先登入以查看購物車");
        window.location.href = "{% url 'login' %}";
    {% endif %}
});
</script>

{% endblock %}
